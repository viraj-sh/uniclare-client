name: Build Windows Executable

on:
  push:
    branches:
      - "**"
    tags:
      - "v*.*.*"

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/base.txt
          pip install pyinstaller

      - name: Build executable
        run: |
          pyinstaller specs\winx64.spec --noconfirm --clean
          mkdir build-output
          # Extract version name (for tags, it'll be like v1.2.0; for commits, fallback to short SHA)
          if ($env:GITHUB_REF -match "refs/tags/") {
            $version = $env:GITHUB_REF.Replace('refs/tags/', '')
          } else {
            $sha = git rev-parse --short HEAD
            $version = "commit-$sha"
          }
          $exeName = "uniclare-client-$version-win-x64.exe"
          Copy-Item "dist\uniclare-client\uniclare-client.exe" "build-output\$exeName"
          echo "EXE_NAME=$exeName" >> $env:GITHUB_ENV

      - name: Upload artifact (for all commits)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.EXE_NAME }}
          path: build-output/${{ env.EXE_NAME }}

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: windows-latest

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          path: build-output

      - name: Create GitHub pre-release
        uses: softprops/action-gh-release@v2
        with:
          files: build-output/**/*.exe
          prerelease: true
          name: uniclare-client ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
