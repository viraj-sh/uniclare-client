name: Update README with latest release version (manual)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout default branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch }}
          fetch-tags: true

      - name: Verify Python and jq installation
        run: |
          python3 --version
          jq --version

      - name: Get latest release tag
        id: latest
        env:
          GH_REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          api="https://api.github.com/repos/${GH_REPO}/releases/latest"
          tag=$(curl -fsSL -H "Authorization: Bearer ${GH_TOKEN}" -H "Accept: application/vnd.github+json" "$api" | jq -r '.tag_name')
          if [ -z "${tag}" ] || [ "${tag}" = "null" ]; then
            echo "Failed to fetch latest release tag" >&2
            exit 1
          fi
          echo "Latest tag: ${tag}"
          echo "LATEST_TAG=${tag}" >> "$GITHUB_ENV"

      - name: Show current README versions
        run: |
          grep -E 'releases/(download|tag)/' README.md || true

      - name: Update README.md if needed
        env:
          LATEST_TAG: ${{ env.LATEST_TAG }}
        run: |
          set -euo pipefail
          python3 .github/scripts/update_readme_version.py "${LATEST_TAG}"

      - name: Commit and push changes (if any)
        env:
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet README.md; then
            echo "No changes to commit"
            exit 0
          fi

          git add README.md
          git commit -m "chore(docs): sync README download links to ${LATEST_TAG}"
          git pull --rebase origin "${DEFAULT_BRANCH}"
          git push origin HEAD:"${DEFAULT_BRANCH}"
