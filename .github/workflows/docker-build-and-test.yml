name: Build and Test Docker Image

on:
  push:
    branches:
      - "**"
    tags:
      - "*"

permissions:
  contents: read

concurrency:
  group: docker-image-${{ github.ref }}
  cancel-in-progress: true

env:
  IMAGE: virajsh/uniclare-client

jobs:
  build:
    name: Build, test, and (on tag) push Docker image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show git info
        run: |
          echo "GITHUB_REF=$GITHUB_REF"
          echo "GITHUB_REF_NAME=${GITHUB_REF##*/}"
          git --no-pager log -1 --pretty=oneline

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Hash JS/CSS Assets
        run: |
          cd app/static
          python3 hash.py hash

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract tag name (if tag)
        id: meta
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            echo "tag_name=$TAG_NAME" >> "$GITHUB_OUTPUT"
          else
            echo "tag_name=" >> "$GITHUB_OUTPUT"
          fi
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "short_sha=$SHORT_SHA" >> "$GITHUB_OUTPUT"

      - name: Build Docker image (with cache)
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64
          # always build locally first; push happens later only on tags
          push: false
          load: true  # <-- ensure image is available to 'docker tag' and 'docker run'
          tags: |
            ${{ env.IMAGE }}:latest
          # cache for faster builds between runs
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # keep base images fresh
          pull: true

      - name: Tag image for version and SHA (only for tag)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG_NAME="${{ steps.meta.outputs.tag_name }}"
          SHORT_SHA="${{ steps.meta.outputs.short_sha }}"
          docker tag $IMAGE:latest $IMAGE:${TAG_NAME}
          docker tag $IMAGE:latest $IMAGE:${SHORT_SHA}

      - name: Run container for testing
        run: |
          echo "Starting container for test..."
          # If your image needs env vars, add them here
          docker run -d -p 8000:8000 --name test-container $IMAGE:latest
          echo "Waiting for app to be ready..."
          # Try up to 60s in 3s intervals
          max_retries=20
          for i in $(seq 1 $max_retries); do
            if curl -sf --max-time 2 http://127.0.0.1:8000/api/v1/health > /dev/null; then
              echo "✅ Health check passed on attempt $i"
              break
            fi
            echo "Attempt $i/$max_retries: server not ready yet, waiting..."
            sleep 3
          done
          # Final check to fail step if still unhealthy
          if ! curl -sf --max-time 2 http://127.0.0.1:8000/api/v1/health > /dev/null; then
            echo "❌ Health check failed after $max_retries attempts"
            docker logs --tail=200 test-container || true
            exit 1
          fi

      - name: Stop and remove test container
        if: always()
        run: |
          docker stop test-container || true
          docker rm test-container || true

      - name: Login to Docker Hub (only for tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Push images (only for tag)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG_NAME="${{ steps.meta.outputs.tag_name }}"
          SHORT_SHA="${{ steps.meta.outputs.short_sha }}"
          # push versioned and latest and SHA tags
          docker push $IMAGE:${TAG_NAME}
          docker push $IMAGE:latest
          docker push $IMAGE:${SHORT_SHA}
